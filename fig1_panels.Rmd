---
title: "Fig1 Panels"
output: html_notebook
---

# Dependencies
```{r}
library(Seurat)
library(tidyverse)
library(ggrastr)
options(ggrastr.default.dpi=600)
```

# Load common data
```{r}
seurat <- readRDS("../../data/pan_cancer_epi.rds")
meta_list <- readRDS("../../output/master_metadata.rds")
```

# Fig 1A - Pan-cancer UMAP

```{r}
dat <- seurat@meta.data
dat$Group <- paste0(dat$Cancer, "_", dat$Source)
dat$UMAP1 <- Embeddings(seurat, 'umap')[,1]
dat$UMAP2 <- Embeddings(seurat, 'umap')[,2]
```

```{r}
cols <- c("#ebac23", "#b80058", "#008cf9", "#006e00", "#00bbad", "#d163e6", "#b24502", "#ff9287")
cancer_plot <- ggplot(dat, aes(UMAP1, UMAP2)) +
  geom_point_rast(size=0.01, shape=16, alpha=0.75, aes(color=Cancer)) +
  scale_colour_manual(values=cols) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  theme_void() +
  theme(legend.title=element_blank(),
        legend.text = element_text(size=12))
cancer_plot
```

```{r}
ggsave(cancer_plot, filename="pan_cancer_umap.pdf", 
       width=5, height=3.25)
```

# Fig 1B
## Arch PCA
Colorectal Lee KUL01 is a decent one to do for this schematic

```{r}
plotArch_PCA <- function(sampleID){
  print(paste0("Processing sample: ", sampleID))
  cells <- rownames(meta_list[[sampleID]])
  seurat_subset <- subset(seurat, cells = cells)
  seurat_subset <- SCTransform(seurat_subset, vars.to.regress="percent.mito")
  seurat_subset <- RunPCA(seurat_subset, verbose=F)
  
  dat <- meta_list[[sampleID]]
  dat$PC1 <- Embeddings(seurat_subset, "pca")[,1]
  dat$PC2 <- Embeddings(seurat_subset, "pca")[,2]
  
  #Get specific cell for each archetype
  dat$Archetype_Membership <- paste0("A", dat$Archetype_Membership)
  archs <- unique(dat$Archetype_Membership)
  arch_dat <- dat[,c("Archetype_Membership", archs)]
  arch_dat$Cell <- rownames(dat)
  arch_dat <- arch_dat %>% 
    pivot_longer(!c(Archetype_Membership, Cell), 
                 names_to = "Archetype",
                 values_to = "Score") %>%
    group_by(Archetype) %>%
    filter(Score == max(Score))
  arch_dat$PC1 <- dat[arch_dat$Cell, "PC1"]
  arch_dat$PC2 <- dat[arch_dat$Cell, "PC2"]
  
  
  pca_plot <- ggplot(dat, aes(PC1, PC2)) +
    geom_point(size=1, shape=16, aes(color=Archetype_Membership), alpha=0.5) +
    geom_point(data=arch_dat, aes(fill=Archetype_Membership), shape=21, 
               colour="black", size=4) +
    scale_color_brewer(palette="Dark2") +
    scale_fill_brewer(palette="Dark2") +
    theme_classic() +
    theme(axis.text=element_text(size=10, color="black"),
          axis.title=element_text(size=12),
          legend.title=element_text(size=12),
          legend.text=element_text(size=12))
  
  pca_no_color <- ggplot(dat, aes(PC1, PC2)) +
    geom_point(size=1, shape=16, color="grey", alpha=0.5) +
    theme_classic() +
    theme(axis.text=element_text(size=10, color="black"),
          axis.title=element_text(size=12),
          legend.title=element_text(size=12),
          legend.text=element_text(size=12))
  
  ggsave(pca_plot, filename= paste0(sampleID,  "_arch_membership.pdf"),
         width=3, height=2.5)
  
}

plotArch_PCA("Colorectal_Lee_KUL01")

```

## Correlation w/ EMT
```{r}
emt_names <- c("CancerSEA", "Hallmark", "GO", 
                     "Cook", "dbEMT", "Puram_pEMT", "Taube",
                     "Kinker_I", "Kinker_II", "Kinker_III")
```

```{r}
getCor <- function(df){
  total_arch <- unique(paste0("A", unique(df$Archetype_Membership)))
  total_arch <- total_arch[order(total_arch)]
  cor_mat <- cor(df[,total_arch], df[,emt_names])
}

cor_dat <- getCor(meta_list[["Colorectal_Lee_KUL01"]])
```

```{r}
gene_set_order <- c("Cook", "Puram_pEMT", "Kinker_III", "dbEMT", "Kinker_I",
                    "GO", "CancerSEA", "Taube", "Hallmark", "Kinker_II")
pheatmap::pheatmap(t(cor_dat[,gene_set_order]),
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = seq(-0.75, 0.75, length.out=101),
         border_col="black",
         cluster_rows = F,
         cluster_cols = F,
         clustering_method="ward.D2",
         filename = "kul01_emt_cor.pdf",
         width=2.5, height=2.4)
```

# Fig 1C
## Heatmap of Ovarian
```{r}
annotation <- unique(seurat@meta.data[,c("Source", "Cancer", "SampleID")])
annotation$Source <- paste0(annotation$Source, "_", annotation$Cancer)
unique_source <- unique(annotation$Source)
```

```{r}
cor_list <- lapply(meta_list, getCor)
all_heatmaps <- list()
for(i in 1:length(unique_source)){
  samples <- annotation %>% filter(Source == unique_source[i]) %>% pull(SampleID)
  
  heat_list <- NULL
  for(n in 1:length(samples)){
    heat <- ComplexHeatmap::pheatmap(t(cor_list[[samples[n]]])[gene_set_order,],
                                   breaks=seq(-0.75,0.75, length.out=100),
                                   color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
                                  cluster_rows=F,
                                  cluster_cols=T,
                                  clustering_method="ward.D2",
                                  treeheight_col = 0,
                                  fontsize = 10,
                                  legend = F,
                                  border_col="black")
    heat_list <- heat_list + heat
  }
  all_heatmaps[[i]] <- heat_list
  draw(all_heatmaps[[i]])
}
```

```{r}
pdf(file = "archetype_emt_correlation_Geistlinger_Ovarian.pdf",
    width=5.5, height=2.15)
all_heatmaps[[7]]
dev.off()
```

## All programs
```{r}
cor_list_merge <- read.csv("../../output/archetype_emt_correlation.csv", row.names=1)
cor_list_merge <- as.matrix(cor_list_merge)
```

```{r}
#cols <- paletteer::paletteer_c("scico::berlin", n=100)
cols <- colorRampPalette(rev(RColorBrewer::brewer.pal(9, "RdBu")))(100)
```

```{r}
emt_cor_heatmap <- pheatmap::pheatmap(t(cor_list_merge[,gene_set_order]),
                                      color = cols,
                                      breaks=seq(-0.75, 0.75, length.out=101),
                                      cluster_rows=F,
                                      cluster_cols=T,
                                      treeheight_col = 15,
                                      show_colnames=F,
                                      cutree_row=3,
                                      fontsize = 12,
                                      angle_col=45,
                                      clustering_method="ward.D2",
                                      filename="archetype_emt_correlation_all.pdf",
                                      width=6.2, height=2.2)
```
