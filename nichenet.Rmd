---
title: "R Notebook"
output: html_notebook
---

# Goal
To get some idea of which stromal cell types may be driving EMP-associated expression programs 

# Dependencies
```{r}
library(Seurat)
library(nichenetr)
library(tidyverse)
```

# Load EMP info
```{r}
program_scores <- read.csv("~/Projects/emt_programs/output/archetype_program_scores.csv")
```

```{r}
assessSig <- function(program){
  hits <- program_scores %>%
    filter(Program == program) %>%
    filter(padj <= 0.05 & coef > 1) %>%
    arrange(desc(padj)) %>% #Just so genes are actually ranked by significance in the list
    pull(Gene)#can add coefficient cutoffs if desired
  return(hits)
}

program_list <- unique(program_scores$Program)
program_genes <- lapply(program_list, assessSig)
names(program_genes) <- program_list
```

```{r}
emt_program_names <- readLines("~/Projects/emt_programs/output/emp_program_list.txt")
emt_program <- program_genes[emt_program_names]
```

```{r}
meta_list <- readRDS("~/Projects/emt_programs/output/master_metadata.rds")
```

# Function through nichenet

A few nichenet components

```{r}
ligand_target_matrix = readRDS(url("https://zenodo.org/record/3260758/files/ligand_target_matrix.rds"))
lr_network = readRDS(url("https://zenodo.org/record/3260758/files/lr_network.rds"))
weighted_networks = readRDS(url("https://zenodo.org/record/3260758/files/weighted_networks.rds"))
weighted_networks_lr = weighted_networks$lr_sig %>% inner_join(lr_network %>% distinct(from,to), by = c("from","to"))
```


```{r}
programCheck <- function(sample_name){
  res <- grep(sample_name, emt_program_names, value=T)
  return(res)
}
```

```{r}
runNichenet <- function(sample){
  # Subset seurat by sample
  print(paste0("Testing sample: ", sample))
  seurat_subset <- subset(seurat, subset = Patient == sample)
  
  #Only want receiver cells to be archetypes - add EMP archetype info to seurat
  meta <- meta_list[[sample]]
  meta$ProgramFull <- paste0(sample, "_A", meta$Archetype_Membership)
  
  meta$EMP <- ifelse(meta$ProgramFull %in% emt_program_names, "_EMP", "")
  meta$CellType <- paste0("Cancer cells", meta$EMP)
  
  ####FIX CELL BARCODE TO REMOVE APPENDED UNIQUE NUMBER FROM COMBINING EPI DATA
  ####THIS IS GROSS
  char_remove <- paste0("_", gsub("^.*_", "", rownames(meta)))
  rownames(meta) <- gsub(paste0(unique(char_remove), "$"), "", rownames(meta))
  ####
  
  seurat_subset$CellType[match(rownames(meta), colnames(seurat_subset))] <- meta$CellType
  
  Idents(seurat_subset) <- seurat_subset$CellType
  
  ### RUN NICHENET
  # Define receiver - EMP cells
  expressed_genes_receiver = get_expressed_genes("Cancer cells_EMP", seurat_subset, pct = 0.05,
                                               assay_oi = "RNA")
  background_expressed_genes = expressed_genes_receiver %>% .[. %in% rownames(ligand_target_matrix)]
  
  # Define senders as all possible cell types
  sender_celltypes = names(table(seurat_subset$CellType))[table(seurat_subset$CellType) > 20] #Don't consider sources w/ <20 cells
  list_expressed_genes_sender = sender_celltypes %>% unique() %>% 
    lapply(get_expressed_genes, seurat_subset, pct = 0.05, assay_oi = "RNA")
  expressed_genes_sender = list_expressed_genes_sender %>% unlist() %>% unique()
  
  ligands = lr_network %>% pull(from) %>% unique()
  receptors = lr_network %>% pull(to) %>% unique()

  expressed_ligands = intersect(ligands,expressed_genes_sender)
  expressed_receptors = intersect(receptors,expressed_genes_receiver)
  potential_ligands = lr_network %>% 
    filter(from %in% expressed_ligands & to %in% expressed_receptors) %>% 
    pull(from) %>% 
    unique()
  
  # Predict ligands
  ligand_activities = predict_ligand_activities(geneset = programs[[sample]], 
                                                background_expressed_genes = background_expressed_genes, 
                                                ligand_target_matrix = ligand_target_matrix, 
                                                potential_ligands = potential_ligands)
  
  ligand_activities$Sample <- sample
  
  ### ADD AVERAGE EXPRESSION
  ligands <- ligand_activities$test_ligand
  dat <- seurat_subset[["RNA"]]@data[ligands,]
  dat <- as.data.frame(t(as.matrix(dat)))
  dat$CellType <- seurat_subset$CellType
  
  dat <- dat %>% 
    pivot_longer(!CellType, names_to="Gene", values_to="Exp") %>%
    group_by(CellType, Gene) %>%
    summarise(pct = sum(Exp > 0) / length(Exp),
              AvgExp = mean(Exp)) %>%
    left_join(ligand_activities, by = c("Gene" = "test_ligand"))
  
  return(dat)
}
```

# Colorectal - Lee - SMC
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_lee/output/seurat_processed_SMC.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Lee_", seurat$Patient)
seurat <- NormalizeData(seurat)
```


```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
colorectal_lee_smc <- lapply(names(programs), runNichenet)
names(colorectal_lee_smc) <- names(programs)
```

# Colorectal - Lee - KUL
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_lee/output/seurat_colorectal_KUL3.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Lee_", seurat$Patient)
seurat <- NormalizeData(seurat)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
colorectal_lee_kul <- lapply(names(programs), runNichenet)
names(colorectal_lee_kul) <- names(programs)
```

# Colorectal Uhlitz
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_uhlitz/output/seurat_processed_tumorOnly.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Uhlitz_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
colorectal_uhlitz <- lapply(names(programs), runNichenet)
names(colorectal_uhlitz) <- names(programs)
```

# Colorectal - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_qian/output/seurat_processed.rds")
seurat$Cancer <- "Colorectal"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Colorectal_Qian_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
colorectal_qian <- lapply(names(programs), runNichenet)
names(colorectal_qian) <- names(programs)
```

# Lung Kim
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_kim/output/seurat_tumours_only.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$Sample
seurat$Patient <- paste0("Lung_Kim_", seurat$Patient)
seurat <- NormalizeData(seurat)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
lung_kim <- lapply(names(programs), runNichenet)
names(lung_kim) <- names(programs)
```

# Lung Lambrechts
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_lambrechts/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$orig.ident
seurat$Patient <- paste0("Lung_Lambrechts_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
lung_lambrechts <- lapply(names(programs), runNichenet)
names(lung_lambrechts) <- names(programs)
```

# Lung Laughney
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_laughney/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Lung_Laughney_", seurat$Patient)
seurat$Patient <- gsub("PRIMARY_TUMOUR", "P", seurat$Patient)
seurat$Patient <- gsub("METASTASIS", "M", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
lung_laughney <- lapply(names(programs), runNichenet)
names(lung_laughney) <- names(programs)
```

# Lung - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_qian/output/seurat_processed.rds")
seurat$Cancer <- "Lung"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Lung_Qian_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
lung_qian <- lapply(names(programs), runNichenet)
names(lung_qian) <- names(programs)
```

# Ovarian Starr
The ovarian data is organized a bit differently than the other seurat objects I have, which makes me have to hack this together a little.
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/ovarian_starr_lab/data/seurat_ovarian_starr.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$orig.ident
seurat$Patient <- paste0("Ovarian_Starr_", seurat$Patient)

#Fix cellbarcodes to be consistent with the meta_list. Seurat object has sampleID appended
#Easier to fix the meta data, but more challenging to implement in the general function
#Will just make a special function here
runNichenet_ovarian <- function(sample){
  # Subset seurat by sample
  seurat_subset <- subset(seurat, subset = Patient == sample)
  
  #Only want receiver cells to be archetypes - add EMP archetype info to seurat
  meta <- meta_list[[sample]]
  meta$ProgramFull <- paste0(sample, "_A", meta$Archetype_Membership)
  
  meta$EMP <- ifelse(meta$ProgramFull %in% emt_program_names, "_EMP", "")
  meta$CellType <- paste0("Cancer cells", meta$EMP)
  
  ####FIX CELL BARCODE TO REMOVE APPENDED UNIQUE NUMBER FROM COMBINING EPI DATA
  ####THIS IS GROSS
  char_remove <- paste0("_", gsub("^.*_", "", rownames(meta)))
  rownames(meta) <- gsub(paste0(unique(char_remove), "$"), "", rownames(meta))
  ####
  
  ####Match rownames w/ seurat object
  sample_name <- tolower(substr(sample, 15, 21))
  sample_name <- gsub("_", "", sample_name)
  rownames(meta) <- paste0(sample_name, "_",
                           substr(rownames(meta), 1, (nchar(rownames(meta))-2)))
  ####
  
  seurat_subset$CellType[match(rownames(meta), colnames(seurat_subset))] <- meta$CellType
  
  Idents(seurat_subset) <- seurat_subset$CellType
  
  ### RUN NICHENET
  # Define receiver - EMP cells
  expressed_genes_receiver = get_expressed_genes("Cancer cells_EMP", seurat_subset, pct = 0.05,
                                               assay_oi = "RNA")
  background_expressed_genes = expressed_genes_receiver %>% .[. %in% rownames(ligand_target_matrix)]
  
  # Define senders as all possible cell types
  sender_celltypes = names(table(seurat_subset$CellType))[table(seurat_subset$CellType) > 20] #Don't consider sources w/ <20 cells
  list_expressed_genes_sender = sender_celltypes %>% unique() %>% 
    lapply(get_expressed_genes, seurat_subset, pct = 0.05, assay_oi = "RNA")
  expressed_genes_sender = list_expressed_genes_sender %>% unlist() %>% unique()
  
  ligands = lr_network %>% pull(from) %>% unique()
  receptors = lr_network %>% pull(to) %>% unique()

  expressed_ligands = intersect(ligands,expressed_genes_sender)
  expressed_receptors = intersect(receptors,expressed_genes_receiver)
  potential_ligands = lr_network %>% 
    filter(from %in% expressed_ligands & to %in% expressed_receptors) %>% 
    pull(from) %>% 
    unique()
  
  # Predict ligands
  ligand_activities = predict_ligand_activities(geneset = programs[[sample]], 
                                                background_expressed_genes = background_expressed_genes, 
                                                ligand_target_matrix = ligand_target_matrix, 
                                                potential_ligands = potential_ligands)
  
  ligand_activities$Sample <- sample
  
  ### ADD AVERAGE EXPRESSION
  ligands <- ligand_activities$test_ligand
  dat <- seurat_subset[["RNA"]]@data[ligands,]
  dat <- as.data.frame(t(as.matrix(dat)))
  dat$CellType <- seurat_subset$CellType
  
  dat <- dat %>% 
    pivot_longer(!CellType, names_to="Gene", values_to="Exp") %>%
    group_by(CellType, Gene) %>%
    summarise(pct = sum(Exp > 0) / length(Exp),
              AvgExp = mean(Exp)) %>%
    left_join(ligand_activities, by = c("Gene" = "test_ligand"))
  
  return(dat)
}
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
ovarian_starr <- lapply(names(programs), runNichenet_ovarian)
names(ovarian_starr) <- names(programs)
```
# Ovarian - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/ovarian_qian/output/seurat_processed.rds")
seurat$Cancer <- "Ovarian"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Ovarian_Qian_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
ovarian_qian <- lapply(names(programs), runNichenet)
names(ovarian_qian) <- names(programs)
```

# PDAC Steele
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/pdac_steele/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$Sample
seurat$Patient <- paste0("PDAC_Steele_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
pdac_steele <- lapply(names(programs), runNichenet)
names(pdac_steele) <- names(programs)
```

# SCC Ji
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/scc_ji/output/seurat_processed_OnlyTumor.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("SCC_Ji_", seurat$Patient)
seurat <- NormalizeData(seurat)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
scc_ji <- lapply(names(programs), runNichenet)
names(scc_ji) <- names(programs)
```

# Uveal Durante
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/uveal_melanoma_durante/output/seurat_processed_annotated.rds")
seurat$Patient <- seurat$orig.ident
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Uveal Melanoma_Durante_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
uveal_durante <- lapply(names(programs), runNichenet)
names(uveal_durante) <- names(programs)
```

# Breast Cancer Wu
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/breast_wu/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Breast_Wu_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
breast_wu <- lapply(names(programs), runNichenet)
names(breast_wu) <- names(programs)
```

# Breast - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/breast_qian/output/seurat_processed.rds")
seurat$Cancer <- "Breast"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Breast_Qian_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
breast_qian <- lapply(names(programs), runNichenet)
names(breast_qian) <- names(programs)
```

# Gastric - Sathe
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/gastric_sathe/output/seurat_processed.rds")
seurat$Cancer <- "Gastric"
seurat$Source <- "Sathe"
seurat$Patient <- paste0("Gastric_Sathe_", seurat$Patient)
```

```{r}
sample_list <- unique(seurat$Patient)
sample_program_list <- lapply(sample_list, programCheck)
names(sample_program_list) <- sample_list
sample_program_list <- sample_program_list[lengths(sample_program_list) > 0]
programs <- list()
for(i in 1:length(sample_program_list)){
  programs[[i]] <- emt_program[sample_program_list[[i]]]
  programs[[i]] <- unique(unlist(programs[[i]]))
}
names(programs) <- names(sample_program_list)
```

```{r}
gastric_sathe <- lapply(names(programs), runNichenet)
names(gastric_sathe) <- names(programs)
```

# Combine data
```{r}
niche_res <- c(colorectal_lee_smc, colorectal_lee_kul, colorectal_uhlitz, colorectal_qian,
                 lung_kim, lung_laughney, lung_lambrechts, lung_qian, pdac_steele,
                 scc_ji, uveal_durante, breast_wu, breast_qian, ovarian_starr, ovarian_qian,
               gastric_sathe)
```

```{r}
saveRDS(niche_res, file="../output/nichenet_res.rds")
```

```{r}
niche_res <- readRDS("../output/nichenet_res.rds")
```

```{r}
niche_res <- do.call("rbind", niche_res)
niche_res <- ungroup(niche_res)
```

# Explore a bit
```{r}
pearson_dist_plot <- niche_res %>%
  select(c(Sample, Gene, pearson)) %>%
  unique() %>%
  ggplot(aes(Sample, pearson)) +
  geom_boxplot(outlier.size = 0, fill="firebrick", alpha=0.5) +
  xlab("") + ylab("Pearson") +
  theme_classic() +
  theme(axis.text.x = element_text(angle=45, hjust=1, colour="black", size=8),
        axis.text.y = element_text(size=10, colour="black"))
ggsave(pearson_dist_plot, filename="../figs/nichenet_pearson_dist.pdf",
       width=15, height=4.75, device=cairo_pdf())
```

```{r}
pearson_dist_plot
```

Given the variation in the distribution, I think something like top 10-20 per sample seems reasonable

```{r}
good_ligands <- niche_res %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>%
  ungroup() %>%
  group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
good_ligands
```

```{r}
good_ligands$Label <- ""
good_ligands$Label[1:40] <- good_ligands$Gene[1:40]

ligand_freq_plot <- ggplot(good_ligands, aes(Rank, Count, label=Label)) +
  geom_point(size=1, color="black") +
  geom_text_repel(colour="firebrick",
                  max.overlaps = Inf,
                  min.segment.length=0,
                  direction="y",
                  nudge_x=125,
                  size=2,
                  hjust=0,
                  segment.size=0.2,
                  segment.alpha=0.75,
                  segment.color="black") +
  xlab("Ranked Ligands") + ylab("Top ligand frequency (/160)") +
  scale_y_continuous(breaks=c(0,20, 40, 60, 80), limits=c(0,88)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size=10, color="black"),
        axis.title.y = element_text(size=12))

ggsave(ligand_freq_plot, filename="../figs/nichenet_top_ligand_freq.pdf",
       width=2.7, height=3.75, device=cairo_pdf())
```

```{r}
ligand_freq_plot
```



# DotPlot Summary

Essentially recreating the standard Seurat dotplot 

```{r}
ligands <- good_ligands$Gene[1:40]
```


```{r}
niche_summary <- niche_res %>%
  filter(Gene %in% ligands) %>%
  group_by(CellType, Gene) %>%
  summarise(Exp = mean(AvgExp, na.rm = T),
            Pct = mean(pct, na.rm=T))
```


I'm going to make a dotplot, but I'd like the ligands/cell types to be ordered in a visually appealing way. I'll make a clustered heatmap, steal the order, and then use it on this
```{r}
niche_tmp <- niche_summary %>%
  select(c("CellType", "Gene", "Exp")) %>%
  pivot_wider(names_from="Gene", values_from="Exp")
niche_mat <- as.matrix(niche_tmp[,2:ncol(niche_tmp)])
rownames(niche_mat) <- niche_tmp$CellType

niche_heat <- pheatmap::pheatmap(niche_mat,
                                 silent=T,
                                 clustering_method = "ward.D2")
```


```{r}
#Aesthetic things
niche_dot <- niche_summary
niche_dot$Exp[niche_dot$Exp > 0.5] <- 0.5
niche_dot$Pct[niche_dot$Pct > 0.5] <- 0.5
niche_dot$CellType <- factor(niche_dot$CellType,
                             levels = rownames(niche_mat)[niche_heat$tree_row$order])
niche_dot$Gene <- factor(niche_dot$Gene,
                             levels = colnames(niche_mat)[niche_heat$tree_col$order])

#Plot
dot <- ggplot(niche_dot, aes(x=Gene, y=CellType)) +
  geom_point(aes(size = Pct, fill = Exp), color="black", shape=21) +
  scale_size("% Exp", range = c(0,6)) +
  scale_fill_gradientn(colours = colorRampPalette(RColorBrewer::brewer.pal(9, "BuPu"))(100),
                       limits = c(0,0.5),
                       guide = guide_colorbar(ticks.colour = "black",
                                              frame.colour = "black"),
                       name = "Avg Exp") +
  ylab("") + xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(size=10, angle=45, hjust=1, color="black"),
        axis.text.y = element_text(size=12, color="black"))

#Save
ggsave(dot, filename="../figs/nichnet_dotplot.pdf",
       device = cairo_pdf(),
       width=12, height=4.25)
ggsave(dot, filename="../figs/nichnet_dotplot.png",
       width=12, height=4.25)
```

# PROGENy w/ ligand
## Prep data
```{r}
sample_list <- names(meta_list)
```

```{r}
#pathways <- colnames(progeny_mat)
pathways <- c("Androgen", "EGFR", "Estrogen", "Hypoxia", "JAK-STAT", "MAPK", "NFkB", "p53", "PI3K", "TGFb", "TNFa", "Trail", "VEGF", "WNT")

testPathway <- function(pathway, program, df){
  score_norm <- df[,program] / max(df[,program])
  test_summary <- summary(lm(df[,pathway] ~ score_norm))
  test_res <- data.frame(Coef = test_summary$coefficients[2,1],
                         pval = test_summary$coefficients[2,4],
                         Pathway = pathway)
  return(test_res)
}

runPathwayTests <- function(sampleID){
  print(paste0("Testing: ", sampleID))
  df <- meta_list[[sampleID]]
  total_arch <- unique(paste0("A", unique(df$Archetype_Membership)))
  total_arch <- total_arch[order(total_arch)]
  
  pathway_test_res <- list()
  for(i in 1:length(total_arch)){
    test_summary <- lapply(pathways, testPathway, program = total_arch[i], df = df)
    test_summary <- do.call("rbind", test_summary)
    test_summary$padj <- p.adjust(test_summary$pval, method="BH")
    test_summary$Program <- paste0(sampleID, "_", total_arch[i])
    pathway_test_res[[i]] <- test_summary
  }
  
  pathway_test_res <- do.call("rbind", pathway_test_res)
}
```

```{r}
pathway_scores <- lapply(sample_list, runPathwayTests)
pathway_scores <- do.call("rbind", pathway_scores)
```

```{r}
pathway_coef <- pathway_scores
pathway_coef$padj <- NULL
pathway_coef$pval <- NULL
pathway_coef <- pivot_wider(pathway_coef, names_from=Pathway, values_from=Coef)
pathway_coef <- as.data.frame(pathway_coef)
rownames(pathway_coef) <- pathway_coef$Program
pathway_coef$Program <- NULL
pathway_coef <- as.matrix(pathway_coef)
```

```{r}
pca_res <- prcomp(pathway_coef, scale=F)
```

```{r}
emp_programs <- readLines("../output/emp_program_list.txt")
emt_program <- factor(rownames(pathway_coef) %in% emp_programs)
```

```{r}
pca1 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = emt_program, repel=T) +
  scale_color_manual(values=c('lightgrey', 'firebrick'))

pca1
```

## Add ligands
```{r}
good_ligands <- niche_res %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>% #results are actually a bit cleaner if you go with top 10
  ungroup()



good_ligand_count <- good_ligands %>% group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
```

Ones I can look into
```{r}
ligand_list <- good_ligand_count %>% filter(Count >= 5) %>% pull(Gene)
```

# Ligand hit PCA
```{r}
testLigand <- function(gene){
  ligand_count <- filter(good_ligand_count, Gene == gene) %>% pull(Count)
  
  progs <- good_ligands %>%
    filter(Gene == gene) %>%
    pull(Sample)

progs <- factor(rownames(pathway_coef) %in% emp_programs &
                        substr(rownames(pathway_coef), 1,
                      nchar(rownames(pathway_coef))-3) %in% progs)

pca_plot <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = progs, repel=T) +
  scale_color_manual(values=c('lightgrey', 'firebrick'))

ggsave(pca_plot, filename=paste0("../figs/nichenet_hits_pca/", ligand_count, "_", gene, ".pdf"),
       width=5, height=4)
}
```

```{r}
lapply(ligand_list, testLigand)
```


### TGFB1

```{r}
#Reminder: rownames(pathway_coef) is what the PCA was done on
tgfb1_progs <- good_ligands %>%
  filter(Gene == "TGFB1") %>%
  pull(Sample)

tgfb1_progs <- factor(rownames(pathway_coef) %in% emp_programs &
                        substr(rownames(pathway_coef), 1,
                      nchar(rownames(pathway_coef))-3) %in% tgfb1_progs)

pca_tgfb1 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = tgfb1_progs, repel=T) +
  scale_color_manual(values=c('lightgrey', 'firebrick'))

pca_tgfb1
```

### STAT (IL1B)

```{r}
#Reminder: rownames(pathway_coef) is what the PCA was done on
il1b_progs <- good_ligands %>%
  filter(Gene %in% c("IL1B")) %>%
  pull(Sample)

il1b_progs <- factor(rownames(pathway_coef) %in% emp_programs &
                        substr(rownames(pathway_coef), 1,
                      nchar(rownames(pathway_coef))-3) %in% il1b_progs)

pca_il1b <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = il1b_progs, repel=T) +
  scale_color_manual(values=c('lightgrey', 'firebrick'))

pca_il1b
```

### EGFR/MAPK

```{r}
#Reminder: rownames(pathway_coef) is what the PCA was done on
mapk_progs <- good_ligands %>%
  filter(Gene %in% c("ITGB7", "ITGB1", "FGF1",
                     "HBEGF")) %>%
  pull(Sample)

mapk_progs <- factor(rownames(pathway_coef) %in% emp_programs &
                        substr(rownames(pathway_coef), 1,
                      nchar(rownames(pathway_coef))-3) %in% mapk_progs)

pca_mapk <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = mapk_progs, repel=T) +
  scale_color_manual(values=c('lightgrey', 'firebrick'))

pca_mapk
```

# Overlap of ligand hits
```{r}
hit_list <- niche_res %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>%
  ungroup()

makeHitList <- function(sample){
  dat <- filter(hit_list, Sample == sample) %>%
    pull(Gene)
}

all_samples <- unique(hit_list$Sample)
hit_list <- lapply(all_samples, makeHitList)
names(hit_list) <- all_samples
```


```{r}
getJaccard <- function(Sample){
  jaccard_scores <- 0
  for(i in 1:length(hit_list)){
    jaccard_scores[i] <- length(intersect(hit_list[[Sample]], hit_list[[i]])) / length(union(hit_list[[Sample]], hit_list[[i]]))
  }
  names(jaccard_scores) <- names(hit_list)
  return(jaccard_scores)
}
```

```{r}
jaccard <- lapply(all_samples, getJaccard)
jaccard <- do.call(rbind, jaccard)
rownames(jaccard) <- colnames(jaccard)
```

```{r}
pheatmap::pheatmap(jaccard,
         color = viridis::inferno(100),
         border_color = "black",
         breaks = seq(0, 0.5, length.out=101),
         clustering_method="ward.D2",
         show_colnames = T,
         show_rownames = F,
         angle_col = 45,
         fontsize_col = 4,
         filename="../figs/nichenet_top20_jaccard.png",
         width=8, height=8) 
```

# Compare EGFR/MAPK vs. JAK-STAT
```{r}
mapk_programs <- rownames(pca_res$x)[rownames(pca_res$x) %in% emp_programs &
                                       pca_res$x[,2] < -1 &
                                       pca_res$x[,1] < 0]
mapk_programs <- substr(mapk_programs, 1, nchar(mapk_programs)-3) %>% unique()

stat_programs <- rownames(pca_res$x)[rownames(pca_res$x) %in% emp_programs &
                                       pca_res$x[,2] > 1 &
                                       pca_res$x[,1] < 0]
stat_programs <- substr(stat_programs, 1, nchar(stat_programs)-3) %>% unique()
```

```{r}
mapk_ligands <- niche_res %>%
  filter(Sample %in% mapk_programs) %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>% #results are actually a bit cleaner if you go with top 10
  ungroup()



mapk_ligand_count <- mapk_ligands %>% group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
mapk_ligand_count$Count <- mapk_ligand_count$Count / length(mapk_programs)
#The above line accounts for differences in the number of MAPK and STAT-associated programs. Convert to proportion


stat_ligands <- niche_res %>%
  filter(Sample %in% stat_programs) %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>% #results are actually a bit cleaner if you go with top 10
  ungroup()



stat_ligand_count <- stat_ligands %>% group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
stat_ligand_count$Count <- stat_ligand_count$Count / length(stat_programs) 
```

```{r}
common_ligands <- intersect(mapk_ligand_count, stat_ligand_count)

merge_dat <- left_join(mapk_ligand_count, stat_ligand_count, by="Gene")
merge_dat <- na.omit(merge_dat)
merge_dat$CountDiff <- merge_dat$Count.x - merge_dat$Count.y #The difference in proportion
merge_dat <- arrange(merge_dat, desc(CountDiff))
merge_dat$Rank <- 1:nrow(merge_dat)

```

## Plot
Add colour by cell type with highest expression maybe??
```{r}
mapk_ligands <- c(merge_dat %>% filter(CountDiff > 0.1) %>% pull(Gene)) 
stat_ligands <- c(merge_dat %>% filter(CountDiff < -0.1) %>% pull(Gene))

merge_dat$mapk_Label <- ""
merge_dat$mapk_Label[match(mapk_ligands, merge_dat$Gene)] <- mapk_ligands

merge_dat$stat_Label <- ""
merge_dat$stat_Label[match(stat_ligands, merge_dat$Gene)] <- stat_ligands

# Get expression info for ligands
niche_summary <- niche_res %>%
  filter(Gene %in% unique(merge_dat$Gene)) %>%
  group_by(CellType, Gene) %>%
  summarise(Exp = mean(AvgExp, na.rm = T),
            Pct = mean(pct, na.rm=T)) %>%
  ungroup() %>%
  group_by(Gene) %>%
  filter(Exp == max(Exp))

merge_dat <- left_join(merge_dat, niche_summary, by="Gene")
merge_dat$CellType <- factor(merge_dat$CellType, 
                             levels = c("Cancer cells_EMP", "Cancer cells", "Fibroblasts", 
                                        "Endothelial", "Macrophages", "B cells", 
                                        "T cells", "NK cells", "Other"))

# Plot
diff_plot <- ggplot(merge_dat, aes(x=Rank, y=CountDiff)) +
  geom_point(aes(fill=CellType, size=Exp), colour="black", shape=21, alpha=0.6) +
  geom_hline(yintercept = c(-0.1, 0.1), linetype=2) +
  geom_text_repel(aes(label = mapk_Label, color=CellType),
                  nudge_x = 50,
                  direction = "y",
                  force=0.5,
                  ylim = c(0.1,NA),
                  hjust= 0,
                  size=3,
                  segment.size = 0.2,
                  segment.color="black") +
  geom_text_repel(aes(label = stat_Label, color=CellType),
                  nudge_x = -50,
                  force=0.5,
                  direction = "y",
                  ylim = c(NA,-0.1),
                  hjust= 1,
                  size=3,
                  segment.size = 0.2,
                  segment.color="black") +
  scale_y_continuous(expand = c(0, 0), breaks=c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3), limits=c(-0.3, 0.3)) +
  scale_fill_manual(values = RColorBrewer::brewer.pal(9, "Set1"),
                    name="Highest expressing\ncell type") +
  scale_colour_manual(values = RColorBrewer::brewer.pal(9, "Set1"),
                    name="Highest expressing\ncell type") +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  ylab("Difference in program frequency") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.text.y = element_text(size=10, colour="black"),
        axis.title.y = element_text(size=12),
        legend.text = element_text(size=10, color="black"),
        legend.title = element_text(size=12))

diff_plot
```

```{r}
ggsave(diff_plot, filename="../figs/nichenet_mapk_stat_difference.pdf",
       device=cairo_pdf(),
       width=5.5, height=4.5)
```

