---
title: "R Notebook"
output: html_notebook
---
# Goal
Go through each tumour dataset and assess the specificity of each EMT signature gene to cancer cells (and specifically those associated with EMP programs). We'll use the genesorteR package for calculating a specificity score rather than just comparing Z-scores or log-transformed counts

# Dependencies
```{r}
library(Seurat)
library(tidyverse)
library(pheatmap)
library(genesorteR)
```

```{r}
emt_sig <- readLines("~/Projects/emt_programs/output/conserved_emt_signature.txt")
emt_programs <- readLines("~/Projects/emt_programs/output/emp_program_list.txt")
meta_list <- readRDS("~/Projects/emt_programs/output/master_metadata.rds")
```

Some organizing
```{r}
for(i in 1:length(meta_list)){
  meta_list[[i]]$Program <- paste0(names(meta_list)[i], "_A", meta_list[[i]]$Archetype_Membership)
}
meta <- do.call("bind_rows", meta_list)
meta$EMP_Program <- ifelse(meta$Program %in% emt_programs, "EMP", "") # See note below
meta$CellBarcode <- rownames(meta)
```

# General function
All seurat objects are organized in a consistent way to deal with this in a single function.

Note: I have the opportunity to calculate the specificity score separately between non-EMP cancer cells and EMP cancer cells, though not 100% clear if it's relevant. If you do it, you do end up getting genes that are really good markers, but if you have a similar specificity score, it doesn't mean that the gene isn't expressed more in the EMP program. So depends on the question. If you want the most specific markers of EMP, do it. If you're just looking for something quantitatively associated with EMP, it's not necessarily the best. I've commented out the line that does that below.

For now, I only really care about specificity in the epithelial component because the signature is going to be used for bulk RNA-seq data from tumours

DAVID: Modify this function to split it by the individual samples within the data set. Function can return a named list.

```{r}
getSpecScore <- function(seurat){
  dat <- seurat@meta.data
  dat$CellBarcode <- rownames(dat)
  
  #tmp <- filter(meta, EMP_Program == "EMP")
  #dat$CellType[dat$CellBarcode %in% tmp$CellBarcode] <- "Cancer cell - EMP"
  
  # Go sample by sample, calculating the specificity score
  sample_list <- unique(dat$Patient)
  
  spec_score_list <- list()
  for(i in 1:length(sample_list)){
    print(paste0("Checking sample: ", sample_list[i]))
    cells_keep <- rownames(dat)[dat$Patient == sample_list[i]]
    dat_subset <- dat[cells_keep,]
    
    #########
    # Omit cell types with <10 cells. Can't calculate reliable specificity w/ so few cells
    count_dat <- dat_subset %>% group_by(CellType) %>% summarise(count = n())
    clusters_keep <- count_dat %>% filter(count >= 10) %>% pull(CellType)
    dat_subset <- filter(dat_subset, CellType %in% clusters_keep)
    cells_keep <- dat_subset$CellBarcode
    #########
    
    emt_sig_good <- emt_sig[emt_sig %in% rownames(seurat)]
    
    spec_score <- sortGenes(seurat[["RNA"]]@data[emt_sig_good, cells_keep],
                            dat_subset$CellType,
                            binarizeMethod = "adaptiveMedian")
    spec_mat <- as.matrix(spec_score$specScore)
    colnames(spec_mat) <- levels(spec_score$inputClass)
    spec_score_list[[i]] <- spec_mat
  }
  
  names(spec_score_list) <- sample_list
  
  return(spec_score_list)
}
```

# Colorectal - Lee - SMC
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_lee/output/seurat_processed_SMC.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Lee_", seurat$Patient)
seurat <- NormalizeData(seurat)
colorectal_lee_smc <- getSpecScore(seurat)
```

# Colorectal - Lee - KUL

```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_lee/output/seurat_colorectal_KUL3.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Lee_", seurat$Patient)
seurat <- NormalizeData(seurat)
colorectal_lee_kul <- getSpecScore(seurat)
```

# Colorectal Uhlitz
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_uhlitz/output/seurat_processed_tumorOnly.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Colorectal_Uhlitz_", seurat$Patient)
colorectal_uhlitz <- getSpecScore(seurat)
```

# Colorectal - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_qian/output/seurat_processed.rds")
seurat$Cancer <- "Colorectal"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Colorectal_Qian_", seurat$Patient)
colorectal_qian <- getSpecScore(seurat)
```

# Lung Kim
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_kim/output/seurat_tumours_only.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$Sample
seurat$Patient <- paste0("Lung_Kim_", seurat$Patient)
seurat <- NormalizeData(seurat)
lung_kim <- getSpecScore(seurat)
```

# Lung Lambrechts
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_lambrechts/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$orig.ident
seurat$Patient <- paste0("Lung_Lambrechts_", seurat$Patient)
lung_lambrechts <- getSpecScore(seurat)
```

# Lung Laughney
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_laughney/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Lung_Laughney_", seurat$Patient)
seurat$Patient <- gsub("PRIMARY_TUMOUR", "P", seurat$Patient)
seurat$Patient <- gsub("METASTASIS", "M", seurat$Patient)
lung_laughney <- getSpecScore(seurat)
```

# Lung - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/lung_qian/output/seurat_processed.rds")
seurat$Cancer <- "Lung"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Lung_Qian_", seurat$Patient)
qian_lung <- getSpecScore(seurat)
```

# Ovarian Starr
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/ovarian_starr_lab/data/seurat_ovarian_starr.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$orig.ident
seurat$Patient <- paste0("Ovarian_Starr_", seurat$Patient)
ovarian_starr <- getSpecScore(seurat)
```

# Ovarian - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/ovarian_qian/output/seurat_processed.rds")
seurat$Cancer <- "Ovarian"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Ovarian_Qian_", seurat$Patient)
qian_ovarian <- getSpecScore(seurat)
```

# PDAC Steele
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/pdac_steele/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- seurat$Sample
seurat$Patient <- paste0("PDAC_Steele_", seurat$Patient)
pdac_steele <- getSpecScore(seurat)
```

# SCC Ji
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/scc_ji/output/seurat_processed_OnlyTumor.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("SCC_Ji_", seurat$Patient)
seurat <- NormalizeData(seurat)
scc_ji <- getSpecScore(seurat)
```

# Uveal Durante
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/uveal_melanoma_durante/output/seurat_processed_annotated.rds")
seurat$Patient <- seurat$orig.ident
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Uveal Melanoma_Durante_", seurat$Patient)
uveal_durante <- getSpecScore(seurat)
```

# Breast Cancer Wu
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/breast_wu/output/seurat_processed.rds")
DefaultAssay(seurat) <- "RNA"
seurat$Patient <- paste0("Breast_Wu_", seurat$Patient)
breast_wu <- getSpecScore(seurat)
```

# Breast - Qian
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/breast_qian/output/seurat_processed.rds")
seurat$Cancer <- "Breast"
seurat$Source <- "Qian"
seurat$Patient <- paste0("Breast_Qian_", seurat$Patient)
qian_breast <- getSpecScore(seurat)
```

# Gastric - Sathe
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/gastric_sathe/output/seurat_processed.rds")
seurat$Cancer <- "Gastric"
seurat$Source <- "Sathe"
seurat$Patient <- paste0("Gastric_Sathe_", seurat$Patient)
gastric_sathe <- getSpecScore(seurat)
```

# Merge all
```{r}
spec_scores <- c(colorectal_lee_smc, colorectal_lee_kul, colorectal_uhlitz, colorectal_qian,
                 lung_kim, lung_laughney, lung_lambrechts, qian_lung, pdac_steele,
                 scc_ji, uveal_durante, breast_wu, qian_breast, ovarian_starr, qian_ovarian,
                 gastric_sathe)
```

Right now there are more samples here than in the epithelial-only data set. This would be samples that didn't have >100 cancer cells

Only keep samples we used
```{r}
seurat <- readRDS("../data/pan_cancer_epi.rds")
sample_list <- unique(seurat$SampleID)
```

```{r}
spec_scores <- spec_scores[sample_list]
```

# Average across all tumours
Want one matrix that's the average for all cell types. Easiest way I can think to do this is to make a tidy data frame
```{r}
for(i in 1:length(spec_scores)){
  spec_scores[[i]] <- as.data.frame(spec_scores[[i]])
  spec_scores[[i]]$Gene <- rownames(spec_scores[[i]])
  spec_scores[[i]] <- pivot_longer(spec_scores[[i]], !Gene, 
                                   names_to = "CellType",
                                   values_to = "Specificity")
  spec_scores[[i]]$Sample <- names(spec_scores)[i]
}
spec_scores <- do.call("bind_rows", spec_scores)
```

I could first calculate an average for each cancer type, and then average those again to normalize for sample count per cancer. For now, I'll just do a simple average though

```{r}
spec_score_avg <- spec_scores %>%
  group_by(CellType, Gene) %>%
  summarise(Avg_Specificity = mean(Specificity))
```

```{r}
spec_score_avg <- pivot_wider(spec_score_avg, names_from="CellType", 
                              values_from = "Avg_Specificity")
spec_score_mat <- as.matrix(spec_score_avg[,2:ncol(spec_score_avg)])
rownames(spec_score_mat) <- spec_score_avg$Gene
spec_score_mat <- spec_score_mat[,c("Cancer cells",
                                    "Fibroblasts", 
                                    "Endothelial",
                                    "Macrophages",
                                    "B cells",
                                    "T cells",
                                    "NK cells",
                                    "Other")]
```

```{r}
spec_score_heat <- pheatmap(spec_score_mat,
         color = viridis::inferno(100),
         breaks = seq(0, 0.25, length.out=101),
         border_color = "black",
         cluster_cols=F,
         cluster_rows=T,
         clustering_method="ward.D2",
         cutree_rows=13,
         show_rownames=T,
         fontsize_row = 4,
         filename = "../figs/emt_sig_avg_specificity.png",
         width=3, height=22)
```

# Compare cancer cells only
Will do like a blow out from the average matrix to a heatmap that's the cancer cells for all samples.
```{r}
spec_scores_epi <- filter(spec_scores, CellType=="Cancer cells") %>%
  pivot_wider(names_from = Sample, values_from=Specificity)
spec_scores_epi$CellType <- NULL
spec_epi_mat <- as.matrix(spec_scores_epi[,2:ncol(spec_scores_epi)])
rownames(spec_epi_mat) <- spec_scores_epi$Gene

```

```{r}
spec_epi_mat[is.na(spec_epi_mat)] <- 0
spec_epi_heat <- pheatmap(spec_epi_mat,
         color = viridis::inferno(100),
         breaks = seq(0, 1, length.out=101),
         border_color = "black",
         cluster_cols=T,
         cluster_rows=T,
         clustering_method="ward.D2",
         show_rownames=T,
         fontsize = 6,
         filename = "../figs/emt_sig_epi_specificity.png",
         width=14, height=15)
```

# Make refined signature of highly specific genes
```{r}
plot(spec_score_heat$gtable)
```
The top and bottom cluster here are pretty solidly specific to epithelial cells. Let's make a refined signature of just these genes

```{r}
clusters <- as.data.frame(cutree(spec_score_heat$tree_row, k=13))
colnames(clusters) <- "Cluster"
clusters$Gene <- rownames(clusters)
table(clusters$Cluster)
```

Order from top to bottom
```{r}
unique(clusters$Cluster[spec_score_heat$tree_row$order])
```

```{r}
refined_sig <- clusters %>% filter(Cluster %in% c(12, 8, 7, 1)) %>% pull(Gene)
```

```{r}
refined_sig
```

```{r}
writeLines(refined_sig, file("../output/emp_sig_refined.txt"))
```

```{r}
write.csv(spec_score_mat, file="../output/specificity_score_matrix.csv")
```


