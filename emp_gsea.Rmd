---
title: "EMP Program GSEA"
output: html_notebook
---

# Goal
Goal here is to take the EMP program differential expression results, run GSEA on each program, and look for patterns across the programs

# Dependencies
```{r}
library(Seurat)
library(tidyverse)
library(fgsea)
library(pheatmap)
```


# Load the data

##  EMP results 
```{r}
program_scores <- read.csv("../output/archetype_program_scores.csv")
emt_programs <- readLines("../output/emp_program_list.txt")
emt_sig <- readLines("../output/conserved_emt_signature.txt")
```

## Gene sets
Generic gene sets
```{r}
hallmarks <- fgsea::gmtPathways("~/Data/GeneLists/hallmark.genesets.v6.1.symbols.gmt")
go <- fgsea::gmtPathways("~/Data/GeneLists/GOTerms.BP.v6.1.symbols.gmt")
```

Include EMT gene sets -- I never really ran GSEA for these, would be nice to confirm!
```{r}
hallmark_emt <- hallmarks["HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION"]

go_terms <- fgsea::gmtPathways("~/Data/GeneLists/GOTerms.BP.v6.1.symbols.gmt")
go_emt <- go_terms["GO_EPITHELIAL_TO_MESENCHYMAL_TRANSITION"]

#cancerSEA
cancer_sea <- readRDS("~/Data/GeneLists/cancerSEA/cancerSEA_gene_sets.rds")
names(cancer_sea) <- paste0("CancerSEA_", names(cancer_sea))
cancer_sea_emt <- cancer_sea["CancerSEA_EMT"]

#My conserved upregulated list
conserved_mes <- list(readr::read_lines("~/Projects/emt_dynamics/output/conserved_upregulated_genes.csv")[-1])
names(conserved_mes) <- "Conserved_EMT_Up"

#My conserved downregulated list
conserved_epi <- list(readr::read_lines("~/Projects/emt_dynamics/output/conserved_downregulated_genes.csv")[-1])
names(conserved_epi) <- "Conserved_EMT_Down"

#dbEMT
dbEMT <- read.csv("~/Data/GeneLists/Zhao_dbEMT.csv")
dbEMT <- list(dbEMT$Symbol)
names(dbEMT) <- "dbEMT"

#Puram HNSCC pEMT
puram <- read.csv("~/Data/GeneLists/puram_hnscc_pEMT_signatures.csv")
puram <- list(unique(puram$Gene)) #All unique genes from their list of 50-gene NMF programs
names(puram) <- "Puram_pEMT"

#Taube Core EMT Up
taube_up <- list(read_lines("~/Data/GeneLists/Taube_Core_EMT_Up.txt"))
names(taube_up) <- "Taube_Core_EMT_Up"

#Kinker et al. EMT signatures
kinker <- read.csv("~/Data/GeneLists/Kinker_Tirosh_RHPs.csv")
kinker_1 <- list(Kinker_1 = kinker$EMT.I)
kinker_2 <- list(Kinker_2 = kinker$EMT.II)
kinker_3 <- list(Kinker_3 = kinker$EMT.III)
```

```{r}
gene_sets <- c(cancer_sea_emt, hallmark_emt,
             go_emt,  conserved_mes, dbEMT, puram, taube_up,
             kinker_1, kinker_2, kinker_3)
```

```{r}
names(gene_sets)
```

```{r}
names(gene_sets) <- c("CancerSEA", "Hallmark", "GO", 
                     "Cook", "dbEMT", "Puram_pEMT", "Taube",
                     "Kinker_I", "Kinker_II", "Kinker_III")
```

# fGSEA functions
```{r}
runGSEA <- function(program){
  print(paste0("Testing: ", which(all_programs == program), " / ", length(all_programs)))
  res <- filter(program_scores, Program == program) %>%
    arrange(desc(coef)) #could maybe do the p-value-weighted coefficient instead?
  ranked_coef <- res$coef
  names(ranked_coef) <- res$Gene
  
  gsea <- fgsea(pathways = gene_sets,
                stats = ranked_coef,
                minSize = 10,
                maxSize = 1000,
                eps = 0,
                nproc = 2)
  gsea <- as.data.frame(gsea)
  gsea$leadingEdge <- as.character(gsea$leadingEdge)
  
  gsea$Program <- program
  
  return(gsea)
}

renamePathways <- function(gsea_res){
  gsea_res <- separate(gsea_res, pathway, c("geneset", "term"), extra="merge")
  gsea_res$term <- gsub("_", " ", gsea_res$term)
  gsea_res$term <- Hmisc::capitalize(tolower(gsea_res$term))
  gsea_res$pathway <- paste0(gsea_res$geneset, ": ", gsea_res$term)
  
  return(gsea_res)
}
```

```{r}
all_programs <- unique(program_scores$Program)
```

# Test EMT Gene sets

Currently the gene_sets variable is just the EMT gene sets

```{r}
gsea_res <- lapply(all_programs, runGSEA)
gsea_res <- do.call("rbind", gsea_res)
```

Convert to an Program X Gene set NES matrix

```{r}
gsea_mat <- gsea_res %>%
  select(c(pathway, NES, Program)) %>%
  pivot_wider(names_from=Program, values_from=NES)

programs <- gsea_mat$pathway
gsea_mat <- as.matrix(gsea_mat[,2:ncol(gsea_mat)])
rownames(gsea_mat) <- programs

annotation_col <- data.frame(EMP = ifelse(colnames(gsea_mat) %in% emt_programs, "EMP", "Other"))
rownames(annotation_col) <- colnames(gsea_mat)
```

```{r}
pheatmap(gsea_mat,
         colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdBu")))(100),
         breaks = seq(-2, 2, length.out=101),
         show_colnames=F,
         clustering_method="ward.D2",
         annotation_col=annotation_col,
         filename = "../figs/gsea_AllPrograms_EMT_sets.png",
         width=6, height=4)
```

# Test hallmarks
```{r}
gene_sets <- hallmarks
```

```{r}
gsea_res <- lapply(all_programs, runGSEA)
gsea_res <- do.call("rbind", gsea_res)
gsea_res <- renamePathways(gsea_res)
```

```{r}
gsea_mat <- gsea_res %>%
  select(c(pathway, NES, Program)) %>%
  pivot_wider(names_from=Program, values_from=NES)

programs <- gsea_mat$pathway
gsea_mat <- as.matrix(gsea_mat[,2:ncol(gsea_mat)])
rownames(gsea_mat) <- programs

annotation_col <- data.frame(EMP = ifelse(colnames(gsea_mat) %in% emt_programs, "EMP", "Other"))
rownames(annotation_col) <- colnames(gsea_mat)
```

```{r}
pheatmap(gsea_mat,
         colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdBu")))(100),
         breaks = seq(-2, 2, length.out=101),
         show_colnames=F,
         clustering_method="ward.D2",
         annotation_col=annotation_col,
         filename = "../figs/gsea_AllPrograms_Hallmarks.png",
         width=10, height=10)
```

```{r}
pheatmap(gsea_mat[,emt_programs],
         colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdBu")))(100),
         breaks = seq(-2, 2, length.out=101),
         show_colnames=F,
         cluster_cols=T,
         clustering_method="ward.D2",
         annotation_col=annotation_col,
         filename = "../figs/gsea_EMPPrograms_Hallmarks.png",
         width=10, height=10)
```

# Test GO terms
This will take a while
```{r}
gene_sets <- go
```

```{r}
gsea_res <- lapply(all_programs, runGSEA)
gsea_res <- do.call("rbind", gsea_res)
gsea_res <- renamePathways(gsea_res)
write.csv(gsea_res, file="../output/gsea_all_programs_GOTerms.csv")
```

```{r}
gsea_mat <- gsea_res %>%
  select(c(pathway, NES, Program)) %>%
  pivot_wider(names_from=Program, values_from=NES)

programs <- gsea_mat$pathway
gsea_mat <- as.matrix(gsea_mat[,2:ncol(gsea_mat)])
rownames(gsea_mat) <- programs
gsea_mat[is.na(gsea_mat)] <- 0

annotation_col <- data.frame(EMP = ifelse(colnames(gsea_mat) %in% emt_programs, "EMP", "Other"))
rownames(annotation_col) <- colnames(gsea_mat)
```

```{r}
pheatmap(gsea_mat,
         colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdBu")))(100),
         breaks = seq(-2, 2, length.out=101),
         show_colnames=F,
         show_rownames=F,
         clustering_method="ward.D2",
         annotation_col=annotation_col,
         filename = "../figs/gsea_AllPrograms_GO.png",
         width=10, height=10)

pheatmap(gsea_mat[,emt_programs],
         colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7, "RdBu")))(100),
         breaks = seq(-2, 2, length.out=101),
         show_colnames=F,
         show_rownames=F,
         clustering_method="ward.D2",
         filename = "../figs/gsea_EMPPrograms_GO.png",
         width=10, height=10)
```


# PCA on NES values
```{r}
nes_mat <- t(gsea_mat[,emt_programs])
nes_mat[is.na(nes_mat)] <- 0
colnames(nes_mat) <- substr(colnames(nes_mat), 11, nchar(colnames(nes_mat)))
pca_res <- prcomp(nes_mat, scale=F)
```

```{r}
fviz_eig(pca_res) + ylab("Percentage variance explained") + 
  theme(axis.text = element_text(size=10, color="black"),
        axis.title = element_text(size=12))
```

```{r}
pca1 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                repel=T)

pca2 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,3),
                repel=T) 
pca1
pca2
```














