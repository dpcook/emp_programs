---
title: "Figure 3 Panels"
output: html_notebook
---

# Dependencies
```{r}
library(Seurat)
library(tidyverse)
library(pheatmap)
library(ggrastr)
library(ggridges)
library(survival)
library(survminer)
```


# Fig 3A - Gene specificity scores
```{r}
spec_score_mat <- read.csv("../../output/specificity_score_matrix.csv", row.names = 1)
spec_score_mat <- as.matrix(spec_score_mat)
```

```{r}
spec_score_heat <- pheatmap(t(spec_score_mat),
         #color = colorRampPalette(c("white", "firebrick"))(100),
         color = viridis::inferno(100),
         breaks = seq(0, 0.25, length.out=101),
         border_color = "NA",
         cluster_cols=T,
         cluster_rows=F,
         clustering_method="ward.D2",
         treeheight_col = 35,
         cutree_cols = 13,
         show_colnames=F,
         fontsize = 14,
         #angle_col = 45,
         legend=F,
         filename = "emt_sig_avg_specificity.png",
         width=10, height=3.5,
         dpi=600)
```


# Fig 3B - Colorectal scoring
```{r}
seurat <- readRDS("~/Data/single_cell_datasets/colorectal_lee/output/seurat_processed_SMC.rds")
```

```{r}
emt_sig_refined <- readLines("../../output/emp_sig_refined.txt")
seurat <- AddModuleScore(seurat, list(emt_sig_refined), name="EMT_Sig")
```

## UMAP
```{r}
dat <- seurat@meta.data
dat$UMAP1 <- Embeddings(seurat, 'umap')[,1]
dat$UMAP2 <- Embeddings(seurat, 'umap')[,2]
dat$EMT_Sig1[dat$EMT_Sig1 < 0] <-  0
```

```{r}
options(ggrastr.default.dpi=450)
dat_plot_refined <- ggplot(dat, aes(UMAP1, UMAP2)) +
  geom_point_rast(size=0.1, shape=16, alpha=0.5, aes(color=EMT_Sig1)) +
  #scale_color_gradientn(colours=c("lightgrey", "red"))+
  scale_color_gradientn(colours=viridis::inferno(100))+
  theme_void() +
  theme(legend.position="none")
ggsave(dat_plot_refined, filename="colorectal_umap_emp_sig_refined.pdf",
       device=cairo_pdf(), width=4, height=4)
dat_plot_refined
```

## Violin
```{r}
dat <- seurat@meta.data
dat$CellType <- factor(dat$CellType, levels=c("Cancer cells", "Fibroblasts",
                                              "Endothelial", "Macrophages", "B cells",
                                              "T cells", "Other"))

dat_plot <- ggplot(dat, aes(EMT_Sig1, CellType)) +
  geom_density_ridges(aes(fill=CellType), alpha=0.5) +
  xlab("EMP Signature Score") + ylab("") +
  theme_ridges() +s
  theme(legend.position="none")
ggsave(dat_plot, filename="colorectal_ridges_emp_sig_refined.pdf",
       width=4, height=3.25)
dat_plot
```



# Fig 3C - TCGA PFI

See survival_test.Rmd to see how this data frame was generated.

```{r}
clinical_dat <- read.csv("../../output/tcga_clinical_emp.csv", row.names = 1)
```

```{r}
coxph(Surv(PFS.time, PFS)~EMP + Purity + type + Age + Sex, data=clinical_subset)
```

## Ridgeplot of EMP scores
```{r}
dat_plot <- ggplot(clinical_subset, aes(x=EMP, y=type)) +
  geom_density_ridges_gradient(aes(fill=stat(x)),
                               quantile_lines=T, quantiles=2, alpha=0.5) +
  scale_fill_viridis_c(name="EMP Sig", option="A") +
  ylab("Cancer type") + xlab("EMP Signature Score") +
  theme_ridges() +
  theme(legend.position="none")
dat_plot

ggsave(dat_plot, filename="pan_cancer_tcga_emp_score.pdf",
       width=3, height=4)
```


# Fig 3D - TCGA Immune prop
```{r}
immune_proportions <- read.csv("../../output/tcga_immune_composition_emp.csv")
```

```{r}
testEMP <- function(cell_type){
  score <- immune_proportions[,cell_type]
  
  model_res <- summary(lm(score ~ immune_proportions$EMP_Score + immune_proportions$TCGA.Study))
  res <- data.frame(Coef = model_res$coefficients[2,1],
                    pval = model_res$coefficients[2,4],
                    CellType = cell_type)
}
```

```{r}
cell_type_list <- colnames(immune_proportions)[4:25]
```

```{r}
cell_type_list
```

```{r}
#Can log transform proportions to make them a little more normally distributed
immune_proportions[,cell_type_list] <- log(immune_proportions[,cell_type_list] + 0.01)

prop_res <- lapply(cell_type_list, testEMP)
prop_res <- do.call("rbind", prop_res)
prop_res$padj <- p.adjust(prop_res$pval, method="BH")

#order
prop_res <- prop_res %>%
  arrange(Coef)
prop_res$CellType <- factor(prop_res$CellType, levels=prop_res$CellType)
prop_res$Sig <- ifelse(prop_res$padj <= 0.05, "Sig", "Not Sig")
```

```{r}
celltype_plot <- ggplot(prop_res, aes(x=Coef, y = CellType)) +
  geom_point(aes(size=-log10(padj), fill=Coef), shape=21, color="black") +
  geom_vline(xintercept = 0, linetype=2) +
  scale_fill_gradientn(colours=colorRampPalette(rev(brewer.pal(7, "RdBu")))(100), 
                       limits=c(-0.5,0.5)) +
  xlab("EMP Score Coefficient") + ylab("") +
  theme_classic() +
  theme(axis.text.y=element_text(size=12, color="black"),
        axis.text.x=element_text(size=12, color="black"),
        axis.title=element_text(size=13))

ggsave(celltype_plot, filename="pan_cancer_tcga_immune_proportions.pdf",
       device=cairo_pdf(), width=6, height=5)
celltype_plot
```



