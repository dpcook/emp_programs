---
title: "Figure 4 Panels"
output: html_notebook
---

# Dependencies
```{r}
library(Seurat)
library(tidyverse)
library(factoextra)
library(progeny)
```

```{r}
meta_list <- readRDS("../../output/master_metadata.rds")
sample_list <- names(meta_list)
emp_programs <- readLines("../../output/emp_program_list.txt")
emt_sig <- readLines("../../output/conserved_emt_signature.txt")
```

# Fig 4A - PCA of Progeny coeffients
See emp_regulation.Rmd for the script that ran progeny on all the samples. Took a while and saved data into meta_list

First, test each program for changes in pathways
```{r}
#pathways <- colnames(progeny_mat)
pathways <- c("Androgen", "EGFR", "Estrogen", "Hypoxia", "JAK-STAT", "MAPK", "NFkB", "p53", "PI3K", "TGFb", "TNFa", "Trail", "VEGF", "WNT")

testPathway <- function(pathway, program, df){
  score_norm <- df[,program] / max(df[,program])
  test_summary <- summary(lm(df[,pathway] ~ score_norm))
  test_res <- data.frame(Coef = test_summary$coefficients[2,1],
                         pval = test_summary$coefficients[2,4],
                         Pathway = pathway)
  return(test_res)
}

runPathwayTests <- function(sampleID){
  print(paste0("Testing: ", sampleID))
  df <- meta_list[[sampleID]]
  total_arch <- unique(paste0("A", unique(df$Archetype_Membership)))
  total_arch <- total_arch[order(total_arch)]
  
  pathway_test_res <- list()
  for(i in 1:length(total_arch)){
    test_summary <- lapply(pathways, testPathway, program = total_arch[i], df = df)
    test_summary <- do.call("rbind", test_summary)
    test_summary$padj <- p.adjust(test_summary$pval, method="BH")
    test_summary$Program <- paste0(sampleID, "_", total_arch[i])
    pathway_test_res[[i]] <- test_summary
  }
  
  pathway_test_res <- do.call("rbind", pathway_test_res)
}
```

```{r}
pathway_scores <- lapply(sample_list, runPathwayTests)
pathway_scores <- do.call("rbind", pathway_scores)
```

Build coefficient matrix

```{r}
pathway_coef <- pathway_scores
pathway_coef$padj <- NULL
pathway_coef$pval <- NULL
pathway_coef <- pivot_wider(pathway_coef, names_from=Pathway, values_from=Coef)
pathway_coef <- as.data.frame(pathway_coef)
rownames(pathway_coef) <- pathway_coef$Program
pathway_coef$Program <- NULL
pathway_coef <- as.matrix(pathway_coef)
```

PCA
```{r}
pca_res <- prcomp(pathway_coef, scale=F)
```

## Colored by cancer, but only EMP programs
Factoextra provides some nice plotting functionality w/ ggplot2. I think I'll just use its plots

```{r}
program_list <- data.frame(Program = rownames(pathway_coef),
                           EMP = ifelse(rownames(pathway_coef) %in% emp_programs, "EMP", "Other"),
                           Cancer = gsub("_.*$", "", rownames(pathway_coef))) #remove all characters after the first underscore
program_list <- arrange(program_list, desc(EMP))
program_list$Cancer[which(program_list$EMP == "Other")] <- "Z"
cols <- c("#ebac23", "#b80058", "#008cf9", "#006e00", "#00bbad", "#d163e6", "#b24502", "#ff9287", "lightgrey")

pca_res$x <- pca_res$x[program_list$Program,]
```


```{r}
pca1 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = program_list$Cancer, col.var = "black",
                repel=T, ggtheme = theme_classic(),
                pointshape = 19, pointsize=1.2, title="Cancer Type") + #oversize points -- remove stroke in Designer
  scale_color_manual(values=cols) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  theme(axis.text=element_text(size=10, colour='black'),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12))

ggsave(pca1, filename="progeny_pca_cancer.pdf", device=cairo_pdf(),
       width=6, height=3.5)

pca1
```


# Fig 4B - Ligand count
Data from nichenet.Rmd

```{r}
niche_res <- readRDS("../output/nichenet_res.rds")
```

```{r}
niche_res <- do.call("rbind", niche_res)
niche_res <- ungroup(niche_res)
```

Get top 20 ligands for each sample, count how often each ligand comes up
```{r}
good_ligands <- niche_res %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>%
  ungroup() %>%
  group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
good_ligands
```

```{r}
good_ligands$Label <- ""
good_ligands$Label[1:40] <- good_ligands$Gene[1:40]

ligand_freq_plot <- ggplot(good_ligands, aes(Rank, Count, label=Label)) +
  geom_point(size=1, color="black") +
  geom_text_repel(colour="firebrick",
                  max.overlaps = Inf,
                  min.segment.length=0,
                  direction="y",
                  nudge_x=150,
                  size=1.75,
                  hjust=0,
                  segment.size=0.2,
                  segment.alpha=0.75,
                  segment.color="black") +
  xlab("Ranked Ligands (1-289)") + ylab("Top ligand frequency (/160)") +
  scale_y_continuous(breaks=c(0,20, 40, 60, 80, 100), limits=c(0,100)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size=10, color="black"),
        axis.title.y = element_text(size=12))

ggsave(ligand_freq_plot, filename="nichenet_top_ligand_freq.pdf",
       width=3, height=3.2, device=cairo_pdf())


ligand_freq_plot
```


# Fig 4C - Ligand dot plot
```{r}
ligands <- good_ligands$Gene[1:40]
```


```{r}
niche_summary <- niche_res %>%
  filter(Gene %in% ligands) %>%
  group_by(CellType, Gene) %>%
  summarise(Exp = mean(AvgExp, na.rm = T),
            Pct = mean(pct, na.rm=T))
```


I'm going to make a dotplot, but I'd like the ligands/cell types to be ordered in a visually appealing way. I'll make a clustered heatmap, steal the order, and then use it on this
```{r}
niche_tmp <- niche_summary %>%
  select(c("CellType", "Gene", "Exp")) %>%
  pivot_wider(names_from="Gene", values_from="Exp")
niche_mat <- as.matrix(niche_tmp[,2:ncol(niche_tmp)])
rownames(niche_mat) <- niche_tmp$CellType

niche_heat <- pheatmap::pheatmap(niche_mat,
                                 silent=T,
                                 clustering_method = "ward.D2")
```


```{r}
#Aesthetic things
niche_dot <- niche_summary
niche_dot$Exp[niche_dot$Exp > 0.5] <- 0.5
niche_dot$Pct[niche_dot$Pct > 0.5] <- 0.5
niche_dot$CellType <- factor(niche_dot$CellType,
                             levels = rownames(niche_mat)[niche_heat$tree_row$order])
niche_dot$Gene <- factor(niche_dot$Gene,
                             levels = colnames(niche_mat)[niche_heat$tree_col$order])

#Plot
dot <- ggplot(niche_dot, aes(x=Gene, y=CellType)) +
  geom_point(aes(size = Pct, fill = Exp), color="black", shape=21) +
  scale_size("% Exp", range = c(0,6)) +
  scale_fill_gradientn(colours = colorRampPalette(RColorBrewer::brewer.pal(9, "BuPu"))(100),
                       limits = c(0,0.5),
                       guide = guide_colorbar(ticks.colour = "black",
                                              frame.colour = "black"),
                       name = "Avg Exp") +
  ylab("") + xlab("") +
  theme_bw() +
  theme(axis.text.x = element_text(size=10, angle=45, hjust=1, color="black"),
        axis.text.y = element_text(size=12, color="black"))

#Save
ggsave(dot, filename="nichnet_dotplot.pdf",
       device = cairo_pdf(),
       width=10, height=4.25)
```

# Fig 4D - MAPK / Hypoxia difference

Will make use of PCA results from Fig 4A above

## PCA component
```{r}
mapk_programs <- rownames(pca_res$x)[rownames(pca_res$x) %in% emp_programs &
                                       pca_res$x[,2] < -1 &
                                       pca_res$x[,1] < 0]


stat_programs <- rownames(pca_res$x)[rownames(pca_res$x) %in% emp_programs &
                                       pca_res$x[,2] > 1 &
                                       pca_res$x[,1] < 0]
```

```{r}
program_list$Group <- "Z"
program_list$Group[program_list$Program %in% mapk_programs] <- "MAPK"
program_list$Group[program_list$Program %in% stat_programs] <- "STAT"

cols <- RColorBrewer::brewer.pal(3, "Dark2")
cols[3] <- "lightgrey"
```


```{r}
pca1 <- fviz_pca_biplot(pca_res, geom.ind="point", axes=c(1,2),
                col.ind = program_list$Group, col.var = "black",
                repel=T, ggtheme = theme_classic(),
                pointshape = 19, pointsize=1.2) + #oversize points -- remove stroke in Designer
  scale_color_manual(values=cols) +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  theme(axis.text=element_text(size=10, colour='black'),
        axis.title=element_text(size=12),
        legend.text=element_text(size=12))

ggsave(pca1, filename="progeny_mapk_stat.pdf", device=cairo_pdf(),
       width=5, height=3.5)

pca1
```

## Setup ligands

```{r}
mapk_programs <- substr(mapk_programs, 1, nchar(mapk_programs)-3) %>% unique()
mapk_ligands <- niche_res %>%
  filter(Sample %in% mapk_programs) %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>% #results are actually a bit cleaner if you go with top 10
  ungroup()



mapk_ligand_count <- mapk_ligands %>% group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
mapk_ligand_count$Count <- mapk_ligand_count$Count / length(mapk_programs)
#The above line accounts for differences in the number of MAPK and STAT-associated programs. Convert to proportion

stat_programs <- substr(stat_programs, 1, nchar(stat_programs)-3) %>% unique()
stat_ligands <- niche_res %>%
  filter(Sample %in% stat_programs) %>%
  select(c("Sample", "pearson", "Gene")) %>%
  unique() %>%
  group_by(Sample) %>%
  top_n(20, pearson) %>% #results are actually a bit cleaner if you go with top 10
  ungroup()



stat_ligand_count <- stat_ligands %>% group_by(Gene) %>%
  summarise(Count = length(Sample)) %>%
  arrange(desc(Count)) %>%
  mutate(Rank = 1:nrow(.))
stat_ligand_count$Count <- stat_ligand_count$Count / length(stat_programs) 
```

```{r}
common_ligands <- intersect(mapk_ligand_count, stat_ligand_count)

merge_dat <- left_join(mapk_ligand_count, stat_ligand_count, by="Gene")
merge_dat <- na.omit(merge_dat)
merge_dat$CountDiff <- merge_dat$Count.x - merge_dat$Count.y #The difference in proportion
merge_dat <- arrange(merge_dat, desc(CountDiff))
merge_dat$Rank <- 1:nrow(merge_dat)
```

## Plot
Add colour by cell type with highest expression maybe??
```{r}
mapk_ligands <- c(merge_dat %>% filter(CountDiff > 0.075) %>% pull(Gene)) 
stat_ligands <- c(merge_dat %>% filter(CountDiff < -0.075) %>% pull(Gene))

merge_dat$mapk_Label <- ""
merge_dat$mapk_Label[match(mapk_ligands, merge_dat$Gene)] <- mapk_ligands

merge_dat$stat_Label <- ""
merge_dat$stat_Label[match(stat_ligands, merge_dat$Gene)] <- stat_ligands

# Get expression info for ligands
niche_summary <- niche_res %>%
  filter(Gene %in% unique(merge_dat$Gene)) %>%
  group_by(CellType, Gene) %>%
  summarise(Exp = mean(AvgExp, na.rm = T),
            Pct = mean(pct, na.rm=T)) %>%
  ungroup() %>%
  group_by(Gene) %>%
  filter(Exp == max(Exp))

merge_dat <- left_join(merge_dat, niche_summary, by="Gene")
merge_dat$CellType <- factor(merge_dat$CellType, 
                             levels = c("Cancer cells_EMP", "Cancer cells", "Fibroblasts", 
                                        "Endothelial", "Macrophages", "B cells", 
                                        "T cells", "NK cells", "Other"))

# Plot
diff_plot <- ggplot(merge_dat, aes(x=Rank, y=CountDiff)) +
  geom_point(aes(fill=CellType, size=Exp), colour="black", shape=21, alpha=0.6) +
  geom_hline(yintercept = c(-0.075, 0.075), linetype=2) +
  geom_text_repel(aes(label = mapk_Label, color=CellType),
                  nudge_x = 25,
                  direction = "y",
                  force=0.5,
                  ylim = c(0.075,NA),
                  hjust= 0,
                  size=2.5,
                  segment.size = 0.2,
                  segment.color="black") +
  geom_text_repel(aes(label = stat_Label, color=CellType),
                  nudge_x = -25,
                  force=0.5,
                  direction = "y",
                  ylim = c(NA,-0.075),
                  hjust= 1,
                  size=2.5,
                  segment.size = 0.2,
                  segment.color="black") +
  scale_y_continuous(expand = c(0, 0), breaks=c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3), limits=c(-0.35, 0.35)) +
  scale_fill_manual(values = RColorBrewer::brewer.pal(9, "Set1"),
                    name="Highest expressing\ncell type") +
  scale_colour_manual(values = RColorBrewer::brewer.pal(9, "Set1"),
                    name="Highest expressing\ncell type") +
  guides(colour = guide_legend(override.aes = list(size=4))) +
  ylab("Difference in program frequency") +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.text.y = element_text(size=10, colour="black"),
        axis.title.y = element_text(size=12),
        legend.text = element_text(size=10, color="black"),
        legend.title = element_text(size=12))

ggsave(diff_plot, filename="nichenet_mapk_stat_diff.pdf",
       device=cairo_pdf(), width=4.75, height=4)

diff_plot
```

